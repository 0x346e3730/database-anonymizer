#!/usr/bin/env php
<?php

use Symfony\Component\Console\Application;
use Symfony\Component\Config\FileLocator;
use Symfony\Component\Console\DependencyInjection\AddConsoleCommandPass;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Loader\XmlFileLoader;
use WebnetFr\DatabaseAnonymizer\DependencyInjection\Compiler\ChainGeneratorFactoryPass;
use WebnetFr\DatabaseAnonymizer\DependencyInjection\Compiler\GeneratorFactoryPass;

set_time_limit(0);

$files = [__DIR__.'/../vendor/autoload.php', __DIR__.'/../../../autoload.php'];
foreach ($files as $file) {
    if (file_exists($file)) {
        $loader = require $file;

        break;
    }
}

if (!class_exists(Application::class)) {
    throw new \RuntimeException('You need to add "symfony/console" as a Composer dependency.');
}

$container = new ContainerBuilder();
$container->addCompilerPass(new AddConsoleCommandPass())
    ->addCompilerPass(new ChainGeneratorFactoryPass());
$loader = new XmlFileLoader($container, new FileLocator(__DIR__.'/../src/Resources/config'));
$loader->load('services.xml');
$container->compile();

$application = (new Application('Database anonymizer', '0.0.1'));
$application->setCommandLoader($container->get('console.command_loader'));
$application
    ->run();
